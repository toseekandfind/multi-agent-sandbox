name: dbt CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'models/**'
      - 'macros/**'
      - 'seeds/**'
      - 'snapshots/**'
      - 'tests/**'
      - 'dbt_project.yml'
      - 'packages.yml'
      - 'profiles.yml'
      - '.github/workflows/dbt-ci.yml'

  # Allow manual trigger
  workflow_dispatch:

env:
  DBT_PROFILES_DIR: ${{ github.workspace }}
  DBT_TARGET: ci
  PYTHON_VERSION: '3.11'

jobs:
  # Generate CI schema name and compute selector
  prepare:
    name: Prepare CI Environment
    runs-on: ubuntu-latest
    outputs:
      ci_schema: ${{ steps.schema.outputs.name }}
      selector: ${{ steps.selector.outputs.value }}
      has_changes: ${{ steps.selector.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Generate CI Schema Name
        id: schema
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          SCHEMA_NAME="ci_${{ github.event.pull_request.number }}_${SHORT_SHA}"
          echo "name=${SCHEMA_NAME}" >> $GITHUB_OUTPUT
          echo "CI Schema: ${SCHEMA_NAME}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Compute Selector
        id: selector
        run: |
          SELECTOR=$(python scripts/dbt_changed_selector.py --smoke-fallback --verbose 2>&1 | tail -1)
          echo "value=${SELECTOR}" >> $GITHUB_OUTPUT

          if [[ -z "$SELECTOR" || "$SELECTOR" == "+tag:ci_smoke+" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

          echo "Selector: ${SELECTOR}"

  # dbt compile - validates all models compile
  compile:
    name: ci/dbt-compile
    runs-on: ubuntu-latest
    needs: prepare
    env:
      DBT_CI_SCHEMA: ${{ needs.prepare.outputs.ci_schema }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake dbt-bigquery dbt-databricks
          # Install project-specific packages if packages.yml exists
          if [[ -f "packages.yml" ]]; then
            dbt deps
          fi

      - name: dbt compile
        run: |
          dbt compile --target ${{ env.DBT_TARGET }}

  # dbt build - scoped to changed models + dependencies
  build:
    name: ci/dbt-build-scoped
    runs-on: ubuntu-latest
    needs: [prepare, compile]
    env:
      DBT_CI_SCHEMA: ${{ needs.prepare.outputs.ci_schema }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake dbt-bigquery dbt-databricks
          if [[ -f "packages.yml" ]]; then
            dbt deps
          fi

      - name: dbt build (scoped)
        run: |
          SELECTOR="${{ needs.prepare.outputs.selector }}"

          if [[ -z "$SELECTOR" ]]; then
            echo "No selector computed, skipping build"
            exit 0
          fi

          echo "Running: dbt build --select \"${SELECTOR}\" --target ${{ env.DBT_TARGET }}"
          dbt build --select "${SELECTOR}" --target ${{ env.DBT_TARGET }}

  # dbt test - explicit test run (can be skipped if build runs tests)
  test:
    name: ci/dbt-test-scoped
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.has_changes == 'true'
    env:
      DBT_CI_SCHEMA: ${{ needs.prepare.outputs.ci_schema }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake dbt-bigquery dbt-databricks
          if [[ -f "packages.yml" ]]; then
            dbt deps
          fi

      - name: dbt test (scoped)
        run: |
          SELECTOR="${{ needs.prepare.outputs.selector }}"

          if [[ -z "$SELECTOR" ]]; then
            echo "No selector computed, skipping tests"
            exit 0
          fi

          echo "Running: dbt test --select \"${SELECTOR}\" --target ${{ env.DBT_TARGET }}"
          dbt test --select "${SELECTOR}" --target ${{ env.DBT_TARGET }}

  # Cleanup CI schema (always runs, even on failure)
  cleanup:
    name: Cleanup CI Schema
    runs-on: ubuntu-latest
    needs: [prepare, build, test]
    if: always()
    env:
      DBT_CI_SCHEMA: ${{ needs.prepare.outputs.ci_schema }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake dbt-bigquery dbt-databricks

      - name: Drop CI Schema
        continue-on-error: true  # Don't fail the workflow if cleanup fails
        run: |
          echo "Cleaning up CI schema: ${{ env.DBT_CI_SCHEMA }}"

          # Use dbt run-operation if available, otherwise use direct SQL
          # This is a placeholder - implement based on your warehouse
          #
          # For Snowflake:
          # dbt run-operation drop_schema --args '{schema: "${{ env.DBT_CI_SCHEMA }}"}'
          #
          # For BigQuery:
          # bq rm -r -f -d project:${{ env.DBT_CI_SCHEMA }}
          #
          # For Databricks:
          # databricks sql --execute "DROP SCHEMA IF EXISTS ${{ env.DBT_CI_SCHEMA }} CASCADE"

          echo "Schema cleanup completed (or skipped if macro not available)"
